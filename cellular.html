<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Cellular Automaton</title>
    <style type="text/css">


* {
  box-sizing: border-box;
}

div#controls {
  position: fixed;
  background-color: rgba(255, 255, 255, 0.8);
  border-radius: 3px;
}

div.control {
  display: inline-block;
  width: 30px;
  text-align: center;
  margin: 3px;
}

div.border {
  display: inline-block;
  float: left;
}

div.border, td.border {
  width: 10px;
  height: 10px;
  border: 1px solid black;
}

div.border.black, td.border.black {
  background-color: black;
}

div.border.white, td.border.white {
  background-color: white;
}


    </style>
    <script type="application/javascript">


var getBitArray = function (n, count) {
  var binaryString = n.toString(2);
  count = count || binaryString.length;

  var result = [];
  var missingCount = count - binaryString.length;
  for (var i = 0; i < count; i++) {
    if(i < missingCount) {
      result[i] = false;
    } else {
      result[i] = binaryString[i - missingCount] === '1';
    }
  }
  return result;
}

function Controls(container) {
  this.inputElements = [];

  for (var i = 0; i < 8; i++) {
    var controlElement = document.createElement('div');
    controlElement.className = 'control';

    var neighborhoodWidth = 3;
    var bits = getBitArray(i, neighborhoodWidth);

    for (var j = 0; j < neighborhoodWidth; j++) {
      var blockElement = document.createElement('div');
      blockElement.className = 'border ' + (bits[j] ? 'white' : 'black');
      controlElement.appendChild(blockElement);
    }

    var checkboxElement = document.createElement('input');
    checkboxElement.type = 'checkbox';
    checkboxElement.addEventListener('click', draw);
    controlElement.appendChild(checkboxElement);
    this.inputElements.push(checkboxElement);

    container.appendChild(controlElement);
  }

  return this;
} 

Controls.prototype.getBitArray = function () {
    var result = [];
    for (var i = 0; i < this.inputElements.length; i++) {
      result[i] = this.inputElements[i].checked;
    }
    return result;
};

Controls.prototype.set = function (n) {
  var isChecked = getBitArray(n, this.inputElements.length);

  for(var i = 0; i < this.inputElements.length; ++i) {
    this.inputElements[i].checked = isChecked[i] ? 'checked' : '';
  }
}

var controls;
var getInitialValue;

function pulse (x, size) {
  return x == Math.floor(size / 2);
}
function random (x) {
  return Math.random() > 0.5;
}

function init() {
  var container = document.getElementById('controls');
  controls = new Controls(container);

  var labelElement = document.createElement('label');

  var randomizeElement = document.createElement('input');
  randomizeElement.type = 'checkbox';
  randomizeElement.addEventListener('click', function (e) {
    if(e.target.checked) {
      getInitialValue = random;
    } else {
      getInitialValue = pulse;
    }
    draw();
  });

  labelElement.textContent = 'Random Input';
  labelElement.insertBefore(randomizeElement, labelElement.firstChild);

  container.appendChild(labelElement);

  // rule 30 https://en.wikipedia.org/wiki/Rule_30
  var rule = 30;

  // rule 90 https://en.wikipedia.org/wiki/Rule_90
  // var rule = 90;

  // rule 110 https://en.wikipedia.org/wiki/Rule_110
  // var rule = 110;

  controls.set(rule);
  getInitialValue = pulse;
}

function draw() {
  var canvas = document.getElementById('canvas');

  if (canvas.getContext) {
    var ctx = canvas.getContext('2d');
    
    var r = controls.getBitArray();

    var white = 0xFFFFFFFF;
    var black = 0xff000000;
    var colors = [
      0xFFFF00FF, // fuchsia
      0xFF0000FF, // red
      0xFF00A5FF, // orange
      0xFF00FFFF, // yellow
      0xFF008000, // green
      0xFFFF901E, // dodgerblue
      0xFF800000, // navy
      0xFF800080, // purple
    ];

    var outImageData = ctx.createImageData(canvas.width, 1);
    var outPixels = new Uint32Array(outImageData.data.buffer);

    // initialize canvas with single black pixel in the middle of the first row
    for(var x = 0; x < canvas.width; x++) {
      if(getInitialValue(x, canvas.width)) {
        var color = black;
      } else {
        var color = white;
      }
      outPixels[x] = color;
    }
    ctx.putImageData(outImageData, 0, 0);



    for(var y = 0; y < canvas.height; y++) {
      var inImageData = ctx.getImageData(0, y, canvas.width, 1);
      var inPixels = new Uint32Array(inImageData.data.buffer);

      for(var x = 0; x < canvas.width; x++) {

        var prevPixel = inPixels[x - 1];
        var currPixel = inPixels[x];
        var nextPixel = inPixels[x + 1];
        
        var prevBit = (prevPixel === white || prevPixel === undefined) ? 1 : 0;
        var currBit = (currPixel === white) ? 1 : 0;
        var nextBit = (nextPixel === white || nextPixel === undefined) ? 1 : 0;

        var colorIndex = prevBit << 2 | currBit << 1 | nextBit << 0;
        var color = r[colorIndex] ? colors[colorIndex] : white;

        outPixels[x] = color;
      }

      ctx.putImageData(outImageData, 0, y + 1);
    }

  }
}


    </script>
  </head>
  <body onload="init();draw();">
    <div id="controls"></div>
    <canvas id="canvas" width="5000" height="2500"></canvas>
    </body>
 </html>
